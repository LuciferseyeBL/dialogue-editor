<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å°è©±ç·¨è¼¯ç¥å™¨ï¼šå‡œèˆ‡GPTå°å¤©ä½¿çš„è¾›è‹¦çµæ™¶ V5.7</title>

  <!-- å›ºå®š UI æ¨£å¼ï¼ˆä¸è®“ä½¿ç”¨è€…ç·¨è¼¯ï¼‰ -->
  <style>
@media (max-width: 1024px), (hover: none) and (pointer: coarse) {
  #main {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    height: 95vh;  /* â¬…ï¸ æœ€çµ‚å®šæ¡ˆç‰ˆæœ¬ */
    overflow: hidden;
  }

  #source {
    width: 100% !important;
    flex: 0 0 35%;
    max-height: 40%;
    font-size: 15px;
    line-height: 1.6;
    border-right: none;
    border-bottom: 1px solid #ccc;
    overflow-y: auto;
    box-sizing: border-box;
  }

#preview {
  width: 100% !important;
  flex: 1 1 auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  overscroll-behavior: contain;
  box-sizing: content-box !important;
  padding-bottom: calc(140px + 20vh); /* åŠ å¼·åº•éƒ¨ç·©è¡ç©ºé–“ */
}

.dialogue-content {
  font-size: 1.3rem;
  line-height: 1.9;
}

  .sender-name {
    font-size: 14px;
  }

button {
  font-size: 1rem;
  padding: 12px 0;
  min-height: 52px;
  border-radius: 10px;
  white-space: normal;
  flex: 1 1 23%;
  max-width: 23%;
  text-align: center;
  box-sizing: border-box;
}

#controls {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ccc;
  padding: 10px 8px;
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 8px;
  box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
  z-index: 999;

  max-height: 120px;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

  body {
    padding-bottom: 130px;
  }

  #source, #preview {
    height: 32vh;
  }
}

@media screen and (max-width: 600px) {
  html {
    font-size: 18px;
  }

  button {
    font-size: 1rem;
    padding: 14px 20px;
    min-height: 52px;
    flex: 1 1 45%;
    max-width: 45%;
    border-radius: 10px;
    white-space: normal;
  }

  #controls {
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    padding-bottom: 10px;
  }

.dialogue-content {
  font-size: 1.3rem;
  line-height: 1.9;
  }

.dialogue-content * {
  font-size: inherit;
  line-height: inherit;
  }

}

@media screen and (max-width: 480px) {
  #controls {
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }

  button {
    font-size: 1rem !important;
    padding: 14px 20px !important;
    min-height: 52px !important;
    flex: 1 1 45% !important;
    max-width: 45% !important;
    border-radius: 10px;
    white-space: normal !important;
  }
.dialogue-content {
  font-size: 1.3rem;
  line-height: 1.9;
  }

.dialogue-content * {
  font-size: inherit;
  line-height: inherit;
  }
}

    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    #header { padding: 10px; border-bottom: 1px solid #ccc; text-align: center; font-weight: bold; }
    .role-name-inputs { display: flex; justify-content: space-between; padding: 5px 10px; }
    .role-name-inputs input { width: 48%; padding: 5px; }
    #main { display: flex; flex: 1; overflow: hidden; }
    #source {
      width: 30%; padding: 10px; border-right: 1px solid #ccc;
      box-sizing: border-box; overflow-y: auto;
    }
    #preview {
      width: 70%; padding: 10px; box-sizing: border-box;
      display: flex; flex-direction: column; overflow-y: auto;
      gap: 6px;
    }
    .dialogue {
      padding: 4px 28px 6px 8px;
      margin-top: 0;
      margin-bottom: 0;
      border-radius: 5px; position: relative;
      word-break: break-word; line-height: 1.6;
      display: flex; flex-direction: column;
    }
    .dialogue-content {
      white-space: pre-wrap;
    }
    .number {
      position: absolute; top: 0px; left: 6px;
      font-size: 11px; color: #888; line-height: 1;
    }
.switch-btn {
  position: absolute;
  top: -5px;
  right: 6px;
  font-size: 13px;
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
  line-height: 1;
}

    .dialogue.dragging { opacity: 0.5; }
    #controls {
      padding: 10px; text-align: center; border-top: 1px solid #ccc;
      display: flex; justify-content: center; align-items: center;
      flex-wrap: wrap; gap: 10px;
    }
    .dialogue.chat-left, 
    .dialogue.chat-right {
      margin-top: 0;
      margin-bottom: 0;
    }
    .dialogue-content:empty::before {
      content: attr(placeholder);
      color: #999;
    }
    button { padding: 8px 15px; }
    #clearAllBtn { background: #f44336; color: white; }
    #styleEditorModal {
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      background: white; border: 1px solid #ccc; padding: 10px;
      z-index: 9999; width: 80%; height: 70%; display: none; flex-direction: column;
    }
    #styleEditorModal textarea {
      flex: 1; width: 100%; font-family: monospace;
      font-size: 14px; margin-bottom: 10px;
    }
#styleEditorModal button {
  flex: none !important;
  max-width: 100% !important;
  padding: 8px 12px !important;
  font-size: 14px !important;
  min-height: auto !important;
}
  </style>

  <!-- ä½¿ç”¨è€…å¯ç·¨è¼¯çš„è¼¸å‡ºæ¨£å¼ -->
  <style id="output-style">
.chat-container {
  display: flex;
  flex-direction: column;
  gap: 20px; /* å°è©±æ¡†é–“è· */
  width: 100%;
  font-family: Arial, sans-serif;
  font-weight: 400; /* å°è©±æ¡†å¯¬åº¦ */
  max-width: 100%;
}
.chat-message {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 100%;
  margin-top: 0;
  margin-bottom: 0;
}
/* ä¿®æ”¹äººåç›¸é—œè¨­å®š */
.sender-name {
  font-size: 12px; 
  font-weight: bold;
  margin-bottom: 3px;
  color: #666;
}

/* ä¸è¦å‹• */
.chat-left, .chat-right {
  display: inline-block;
  padding: 10px;
  border-radius: 10px;
  word-wrap: break-word;
  white-space: pre-wrap;
  min-width: 40px;
  width: auto;
  margin-top: 0;
  margin-bottom: 0;
}

/* æ‰‹æ©Ÿé™å®šæ³¡æ³¡å­—é«”å¤§å° */
@media screen and (max-width: 600px) {
  .chat-left, .chat-right {
    font-size: 1rem;
    line-height: 1.7;
  }
}

.chat-left {
  background-color: #F5F5F5; /* å·¦é‚Šå°è©±æ¡†èƒŒæ™¯è‰² */
  color: #1F1F1F; /* å·¦é‚Šå°è©±æ¡†å­—é«”è‰² */
  align-self: flex-start;
  max-width: 70%; /* å°è©±æ¡†å¯¬åº¦ä½”ç•«é¢ç™¾åˆ†æ¯” */
}
.chat-right {
  background-color: #FFBED7; /* å³é‚Šå°è©±æ¡†èƒŒæ™¯è‰² */
  color: #1F1F1F; /* å³é‚Šå°è©±æ¡†å­—é«”è‰² */
  align-self: flex-end;
  max-width: 70%;
}
/* Markdown èªæ³•æ¨£å¼æ”¯æ´èˆ‡é¡è‰² */
em {
  font-style: italic;
  color: #8E8E8E;  /* æ–œé«”å­—é¡è‰²*/
}

strong {
  font-weight: bold;
  color: #1F1F1F; /* ç²—é«”å­—é¡è‰² */
}

em strong {
  font-style: italic;
  font-weight: bold;
  color: #1F1F1F; /* æ–œç²—é«”å­—é¡è‰² */
}
  </style>
</head>
<body>
  <div style="text-align: right; padding: 10px;">
    <a href="https://github.com/LuciferseyeBL/dialogue-editor" target="_blank">
      ğŸ“˜ æŸ¥çœ‹ GitHub èªªæ˜æ–‡ä»¶ï¼ˆREADMEï¼‰
    </a>
  </div>
  <div id="header">ğŸ“š å°è©±ç·¨è¼¯ç¥å™¨ï¼šå‡œèˆ‡GPTå°å¤©ä½¿çš„è¾›è‹¦çµæ™¶ V5.7</div>
  <div class="role-name-inputs">
    <input id="leftRole" placeholder="å·¦å´è§’è‰²å (å¯ç•™ç©º)" />
    <input id="rightRole" placeholder="å³å´è§’è‰²å (å¯ç•™ç©º)" />
  </div>
  <div id="main">
    <div id="source" contenteditable="true"></div>
    <div id="preview"></div>
      <div style="height: 140px; flex-shrink: 0;"></div>
  </div>
  <div id="controls">
    <button onclick="openStyleEditor()">æ¨£å¼è¨­å®š</button>
    <button onclick="deleteSelected()">åˆªé™¤</button>
    <button onclick="mergeNextSameSide()">åˆä½µä¸‹æ–¹åŒå´</button>
    <button onclick="exportTxt()">åŒ¯å‡º TXT</button>
    <button onclick="toggleMode()">æ¨¡å¼åˆ‡æ›</button>
    <span id="mode-status">æ‹–æ›³æ¨¡å¼</span>
    <button id="clearAllBtn" onclick="clearAll()">å…¨éƒ¨æ¸…é™¤</button>
    <button onclick="autoConvertFromSource()">ğŸ”„ è‡ªå‹•è½‰æ›å°è©±æ³¡æ³¡</button>
    <button onclick="flipAllSides()">â†” ä¸€æ¬¡æ€§å°èª¿å·¦å³æ³¡æ³¡</button>
  </div>
  <div id="styleEditorModal">
    <textarea id="styleEditorArea"></textarea>
    <button onclick="applyStyle()">å¥—ç”¨æ¨£å¼</button>
    <button onclick="closeStyleEditor()">é—œé–‰</button>
  </div>
<script>
let selected = null;
let currentOrder = 1;
let mode = "drag";

const preview = document.getElementById("preview");
const modeStatus = document.getElementById("mode-status");
const leftInput = document.getElementById("leftRole");
const rightInput = document.getElementById("rightRole");
const source = document.getElementById("source");

function openStyleEditor() {
  const styleText = document.getElementById("output-style").textContent;
  document.getElementById("styleEditorArea").value = styleText;
  document.getElementById("styleEditorModal").style.display = "flex";
}

function closeStyleEditor() {
  document.getElementById("styleEditorModal").style.display = "none";
}

function applyStyle() {
  const updated = document.getElementById("styleEditorArea").value;
  document.getElementById("output-style").textContent = updated;
  syncPreviewStyle(); 
  closeStyleEditor();
}

function syncPreviewStyle() {
  const styleText = document.getElementById("output-style").textContent;
  const tempStyle = document.createElement("style");
  tempStyle.textContent = styleText;
  document.head.appendChild(tempStyle);

  // æŠ“ chat-container çš„ gap ä¸¦å¥—ç”¨
  const testContainer = document.createElement("div");
  testContainer.className = "chat-container";
  document.body.appendChild(testContainer);
  const computed = getComputedStyle(testContainer);
  preview.style.gap = computed.gap;

  // æ¸…é™¤
  testContainer.remove();
  tempStyle.remove();
}

function processText(text) {
  const lines = text.split(/\r?\n/);
  const converted = lines.map(line => {
    return line
      // å…ˆè™•ç† **ç²—é«”**
      .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
      // å†è™•ç† *æ–œé«”*ï¼Œä½†é¿å…åµŒå¥—åœ¨ç²—é«”ä¸­é–“çš„ * è¢«è™•ç†
      .replace(/(^|[^*])\*(?!\*)(.+?)\*(?!\*)([^*]|$)/g, "$1<em>$2</em>$3")
      .trim();
  });
  return converted.join("<br>");
}

<!-- âœ… æ•´åˆå¾Œç‰ˆæœ¬ï¼šæ”¯æ´æ‰‹æ©Ÿé™å®šå¤§å­—é«”ï¼Œè‡ªå‹•åµæ¸¬ä¸¦å¥—ç”¨ -->
<!-- ä»¥ä¸‹ç‚º createDialogue å‡½å¼ä¸­ä¿®æ”¹éçš„éƒ¨åˆ† -->

function isMobile() {
  return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) || window.innerWidth <= 600;
}

function createDialogue(html, order, side) {
  const div = document.createElement("div");
  const className = side === "left"
   ? "dialogue chat-message chat-left left"
   : "dialogue chat-message chat-right right";
  div.className = className;
  div.dataset.order = order;
  div.dataset.side = side;
  div.setAttribute("draggable", true);

  const number = document.createElement("div");
  number.className = "number";

  const switchBtn = document.createElement("button");
  switchBtn.className = "switch-btn";
  switchBtn.textContent = "â‡„";
  switchBtn.onclick = switchSide;

  const content = document.createElement("div");
  content.className = "dialogue-content";
  content.setAttribute("contenteditable", "false");

content.innerHTML = processText(html.trim());

  // Enter æ”¯æ´å †ç–Š<br>
  content.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      const br = document.createElement("br");
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      range.insertNode(br);
      const prevNode = br.previousSibling;
      if (prevNode && prevNode.nodeName === "BR") {
        const br2 = document.createElement("br");
        range.insertNode(br2);
        range.setStartAfter(br2);
        range.setEndAfter(br2);
      } else {
        range.setStartAfter(br);
        range.setEndAfter(br);
      }
      selection.removeAllRanges();
      selection.addRange(range);
    }
  });

  div.addEventListener("click", () => {
    if (mode === "edit") {
      content.setAttribute("contenteditable", "true");
      content.focus();
      saveState();
    } else {
      if (selected) selected.style.background = "";
      selected = div;
      div.style.background = "#c8e4ff";
    }
  });

  div.addEventListener("dragstart", () => div.classList.add("dragging"));
  div.addEventListener("dragend", () => div.classList.remove("dragging"));

  div.appendChild(number);
  div.appendChild(switchBtn);
  div.appendChild(content);

  return div;
}

function switchSide(e) {
  e.stopPropagation();
  const dlg = e.target.closest(".dialogue");
  const sideNow = dlg.dataset.side;

  // æ¸…é™¤æ‰€æœ‰èˆ‡ side æœ‰é—œçš„ class
  dlg.classList.remove("left", "right", "chat-left", "chat-right");

  // åˆ‡æ›é‚è¼¯
  if (sideNow === "left") {
    dlg.classList.add("right", "chat-right");
    dlg.dataset.side = "right";
  } else {
    dlg.classList.add("left", "chat-left");
    dlg.dataset.side = "left";
  }

  refreshNumbers(); // ç¢ºä¿ç·¨è™Ÿå³æ™‚æ›´æ–°
  syncPreviewStyle(); // â­ é‡æ–°å¥—ç”¨æ¨£å¼ï¼Œå¦å‰‡ DOM ä¸æœƒå³æ™‚æ›´æ–°
  saveState(); // â­ å„²å­˜ç‹€æ…‹ï¼Œå¦å‰‡ reload ä¸ä¿ç•™
}

function getDropTarget(e) {
  const elements = [...preview.querySelectorAll(".dialogue")];
  for (let el of elements) {
    const rect = el.getBoundingClientRect();
    if (e.clientY < rect.top + rect.height / 2) return el;
  }
  return null;
}

function refreshNumbers() {
  const dialogues = [...preview.querySelectorAll(".dialogue")];
  dialogues.forEach((el, idx) => {
    const number = el.querySelector(".number");
    if (number) number.textContent = idx + 1;
  });
}

function deleteSelected() {
  if (selected) {
    selected.remove();
    selected = null;
    refreshNumbers(); saveState();
  }
}

function mergeNextSameSide() {
  if (!selected) return alert("è«‹å…ˆé¸å–ä¸€å€‹å°è©±æ¡†");
  const all = [...preview.querySelectorAll(".dialogue")];
  const idx = all.indexOf(selected);
  if (idx < 0 || idx >= all.length - 1) return alert("æ²’æœ‰å¯åˆä½µçš„ä¸‹ä¸€æ®µå°è©±");

  const next = all[idx + 1];
  if (selected.dataset.side !== next.dataset.side) return alert("ä¸‹ä¸€æ®µä¸æ˜¯åŒå´å°è©±ï¼Œç„¡æ³•åˆä½µ");

  if (!confirm("âš ï¸ å°‡æœƒåˆä½µä¸‹ä¸€æ®µç›¸åŒå´å°è©±æ¡†ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ")) return;

  const contentA = selected.querySelector(".dialogue-content");
  const contentB = next.querySelector(".dialogue-content");

  contentA.innerHTML = contentA.innerHTML.trim() + "<br><br>" + contentB.innerHTML.trim();
  next.remove();

  refreshNumbers();
  saveState();
}

function exportTxt() {
  const sharedStyle = document.getElementById("output-style").textContent;
  const leftRole = leftInput.value.trim();
  const rightRole = rightInput.value.trim();
  const dialogues = [...preview.querySelectorAll(".dialogue")];

  let result = `<style>\n${sharedStyle}\n</style>\n\n<div class="chat-container">\n`;

  dialogues.forEach(dlg => {
    const side = dlg.dataset.side;
    const align = side === "left" ? "flex-start" : "flex-end";
    const cls = side === "left" ? "chat-left" : "chat-right";
    const role = side === "left" ? leftRole : rightRole;
    const roleLine = role ? `  <div class="sender-name">${role}</div>\n` : "";
    const contentEl = dlg.querySelector(".dialogue-content");
    const contentHTML = contentEl ? contentEl.innerHTML.trim() : "";
    result += `<div class="chat-message" style="align-self: ${align};">\n${roleLine}  <div class="${cls}">${contentHTML}</div>\n</div>\n`;
  });

  result += "</div>";

  const blob = new Blob([result], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "dialogue.txt";
  a.click();
  URL.revokeObjectURL(a.href);
}

function toggleMode() {
  mode = mode === "drag" ? "edit" : "drag";
  modeStatus.textContent = mode === "drag" ? "æ‹–æ›³æ¨¡å¼" : "ä¿®æ”¹æ¨¡å¼";
  const contents = document.querySelectorAll(".dialogue-content");
  contents.forEach(el => {
    el.setAttribute("contenteditable", mode === "edit" ? "true" : "false");
    if (mode === "drag") el.blur();
  });
  saveState();
}

function autoConvertFromSource() {
  const rawHTML = source.innerHTML.trim();
  if (!rawHTML) return alert("è«‹å…ˆè²¼ä¸ŠåŸå§‹æ–‡æœ¬åœ¨å·¦å´å€åŸŸï¼");

  const segments = rawHTML.split(/<br><br>/i);
  if (segments.length === 0) return;

  preview.innerHTML = ""; // æ¸…ç©ºç¾æœ‰é è¦½
  currentOrder = 1;

  segments.forEach((seg, idx) => {
    const cleanHTML = seg.trim();
    if (!cleanHTML) return;

    // é è¨­å¥‡å¶æ±ºå®šå·¦å³
    const side = idx % 2 === 0 ? "left" : "right";
    const dlg = createDialogue(cleanHTML, currentOrder++, side);
    preview.appendChild(dlg);
  });

  refreshNumbers();
  saveState();
  alert("å·²è½‰æ›å®Œæˆï¼å¯æ‰‹å‹•å¾®èª¿å·¦å³ä½ç½®èˆ‡è§’è‰²åã€‚");
}

function flipAllSides() {
  const dialogues = preview.querySelectorAll(".dialogue");
  dialogues.forEach(dlg => {
    if (dlg.classList.contains("chat-left")) {
      dlg.classList.remove("chat-left", "left");
      dlg.classList.add("chat-right", "right");
      dlg.dataset.side = "right";
    } else if (dlg.classList.contains("chat-right")) {
      dlg.classList.remove("chat-right", "right");
      dlg.classList.add("chat-left", "left");
      dlg.dataset.side = "left";
    }

    // âœ… ç¢ºä¿åˆ‡æ›æŒ‰éˆ•æ­£å¸¸æ›ä¸Šäº‹ä»¶ï¼ˆé¿å… reload å¾Œå¤±æ•ˆï¼‰
    const switchBtn = dlg.querySelector(".switch-btn");
    if (switchBtn) {
      switchBtn.onclick = switchSide;
    }
  });

  refreshNumbers();
  syncPreviewStyle(); // ç¢ºä¿æ¨£å¼åˆ·æ–°
  saveState(); // â­ é‡æ–°å„²å­˜ç‹€æ…‹ï¼Œå¦å‰‡ reload é‚„æ˜¯æœƒå£æ‰
  alert("â†” æ‰€æœ‰å°è©±æ³¡æ³¡å·²å°èª¿å·¦å³ï¼");
}

function saveState() {
  const data = {
    left: leftInput.value,
    right: rightInput.value,
    source: source.innerHTML,
    order: currentOrder,
    dialogues: [...preview.querySelectorAll(".dialogue")].map(dlg => {
      const contentEl = dlg.querySelector(".dialogue-content");
      const cleanedHTML = contentEl?.innerHTML
        .replace(/<div><br><\/div>/g, "<br>")
        .replace(/<div>/g, "")
        .replace(/<\/div>/g, "<br>") || "";
      return {
        side: dlg.dataset.side,
        html: cleanedHTML
      };
    })
  };

  localStorage.setItem("dialogue-style", document.getElementById("output-style").textContent);
  localStorage.setItem("dialogue-editor-save", JSON.stringify(data));
}

function loadState() {
  const savedStyle = localStorage.getItem("dialogue-style");
  if (savedStyle) {
    document.getElementById("output-style").textContent = savedStyle;
  } else {
    const original = document.getElementById("output-style").textContent;
    localStorage.setItem("dialogue-style", original);
  }

  const data = JSON.parse(localStorage.getItem("dialogue-editor-save") || "{}");
  if (!data.dialogues) {
    source.innerHTML = "è«‹æ–¼æ­¤è™•è²¼ä¸Šæ–‡æœ¬ï¼Œé¸å–æ–‡å­—å¾Œæ‹–æ›³è‡³å³æ–¹å·¥ä½œå€å·¦å´æˆ–å³å´ç”Ÿæˆå°è©±æ¡†<br><br>v5.7å„ªåŒ–ï¼šç¾åœ¨å¯ä»¥åƒæ–‡æœ¬çš„*æ–œé«”å’Œ**ç²—é«”è¨­å®šäº†ï¼ˆä½†æ˜¯ç”Ÿæˆå¾Œè¦åƒèªæ³•è‡ªè¡Œä¿®æ”¹å–”ï¼ï¼‰<br><br>v5.6å„ªåŒ–ï¼šæ‰‹æ©Ÿå¯ä»¥ç”¨ï¼ˆä½†ç¾åœ¨ä¸å¥½ç”¨ï¼‰ã€‚â€»è‡ªå‹•ç”Ÿæˆæ³¡æ³¡è«‹åœ¨æ–‡æœ¬ä»¥ç©ºä¸€è¡Œéš”é–‹æ®µè½ï¼<br><br>v5.5å„ªåŒ–ï¼š<br>1. å·¥ä½œå€å°è©±æ¡†å®Œå…¨åœ°æ‰€è¦‹å³æ‰€å¾—ï¼Œå¯ä¿®æ”¹å°è©±æ¡†é–“è·ç­‰ï¼Œä¸”è¼¸å‡ºå¥—ç”¨ã€‚<br>2. é‡æ•´å¾Œä»è¨˜æ†¶ä¿®æ”¹å¾Œçš„æ¨£å¼è¨­å®šã€‚<br>3. èª¿æ­£æ¨£å¼è¨­å®šå…§çš„éŒ¯å­—ã€‚<br>4. ä¿®BUGï¼šä¿®æ­£åŸå…ˆä¿®æ”¹æ¨¡å¼ç„¡æ³•ä»»æ„ENTERçš„å•é¡Œã€‚";
    return;
  }

  leftInput.value = data.left || "";
  rightInput.value = data.right || "";
  source.innerHTML = data.source || "";
  currentOrder = data.order || 1;

  data.dialogues.forEach(d => {
    const dlg = createDialogue(d.html, currentOrder++, d.side);
    preview.appendChild(dlg);
  });

  // âœ… ä¿®æ­£BUGï¼šç¢ºä¿è¼‰å…¥å¾Œ class èˆ‡æŒ‰éˆ•äº‹ä»¶æ­£ç¢º
  const allDialogs = preview.querySelectorAll(".dialogue");
  allDialogs.forEach(dlg => {
    const side = dlg.dataset.side;
    dlg.classList.remove("chat-left", "chat-right", "left", "right");
    if (side === "left") {
      dlg.classList.add("chat-left", "left");
    } else {
      dlg.classList.add("chat-right", "right");
    }

    const switchBtn = dlg.querySelector(".switch-btn");
    if (switchBtn) {
      switchBtn.onclick = switchSide;
    }
  });

  refreshNumbers();
  syncPreviewStyle();
  // ğŸ” æœ€å¾Œï¼šç¢ºä¿æ¯å€‹æ³¡æ³¡çš„ switch-btn éƒ½æ­£ç¢ºæ›ä¸Šäº‹ä»¶ï¼ˆè§£æ±º reload å¾Œé»æ“Šæ²’åæ‡‰çš„ bugï¼‰
  const allSwitchButtons = preview.querySelectorAll(".switch-btn");
  allSwitchButtons.forEach(btn => {
    btn.onclick = switchSide;
  });
}

function clearAll() {
  if (!confirm("âš ï¸ æœ¬åŠŸèƒ½å°‡å®Œå…¨æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œæ˜¯å¦åŸ·è¡Œï¼Ÿ")) return;
  leftInput.value = "";
  rightInput.value = "";
  source.innerHTML = "";
  preview.innerHTML = "";
  selected = null;
  currentOrder = 1;
  localStorage.removeItem("dialogue-editor-save");
}

window.onload = loadState;

source.addEventListener("paste", e => {
  e.preventDefault();

  const text = (e.clipboardData || window.clipboardData).getData("text/plain");

  // å°‡ç´”æ–‡å­—çš„ \n è½‰æ›ç‚ºçœŸæ­£çš„ TextNode èˆ‡ <br> çµæ§‹
  const lines = text.split(/\r?\n/);
  const fragment = document.createDocumentFragment();

  lines.forEach((line, idx) => {
    fragment.appendChild(document.createTextNode(line));
    // æ¯è¡Œå¾Œè£œ <br>ï¼ˆå³ä½¿æ˜¯ç©ºè¡Œä¹Ÿä¿ç•™ï¼‰
    if (idx < lines.length - 1) fragment.appendChild(document.createElement("br"));
  });

  // æ’å…¥åˆ°ç•¶å‰æ¸¸æ¨™ä½ç½®
  const selection = window.getSelection();
  if (!selection.rangeCount) return;
  const range = selection.getRangeAt(0);
  range.deleteContents();
  range.insertNode(fragment);
});

preview.addEventListener("dragover", e => e.preventDefault());
preview.addEventListener("drop", e => {
  if (mode !== "drag") return;
  e.preventDefault();
  const dragging = document.querySelector(".dialogue.dragging");
  const dropTarget = getDropTarget(e);
  if (dragging) {
    dragging.classList.remove("dragging");
    if (dropTarget) preview.insertBefore(dragging, dropTarget);
    else preview.appendChild(dragging);
    refreshNumbers(); saveState();
  } else {
    const text = e.dataTransfer.getData("text/plain");
    if (text.trim()) {
      const html = processText(text);
      const side = e.clientX < window.innerWidth * 0.65 ? "left" : "right";
      const dlg = createDialogue(html, currentOrder++, side);
      if (dropTarget) preview.insertBefore(dlg, dropTarget);
      else preview.appendChild(dlg);
      refreshNumbers(); preview.scrollTop = preview.scrollHeight;
      saveState();
    }
  }
});
</script>
</body>
</html>
